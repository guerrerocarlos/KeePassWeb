<!DOCTYPE html>
<html>

<head>
  <title>KeePassWeb</title>
</head>
<script src="./cbor.js" type="text/javascript"></script>
<script src="./webauthn.js" type="text/javascript"></script>
<style>
  html,
  body {
    height: 95%;
    font-family: 'Courier New', monospace;
  }

  input {
    font-family: 'Courier New', monospace;
  }

  textarea {
    resize: none;
  }

  .section {
    padding: 10px;
  }

  .fullheight {
    height: 80%;
    /* display: inline; */
  }

  .floatleft {
    display: inline;
    float: left;
    height: 90%;
    width: 50%;
  }

  #plaintext {
    width: 90%;
    height: 95%;
    display: inline;
    padding: 4%;
    margin: 1%;
  }

  #encrypted {
    width: 90%;
    height: 78%;
    display: inline;
    font-size: 0.8em;
    padding: 2%;
    margin: 1%;
  }

  #password {
    display: inline;
  }

  .padded {
    margin: 2%;
  }

  #errorMessage {
    color: red;
    display: inline;
    font-style: bold;
  }

  #lockButton {
    float: right;
    color: #fff;
    border: white;
    font-size: 5em;
    border-radius: 4px;
    margin-right: 10px;
    box-shadow: 2px 2px 9px 2px #ccc;
    text-shadow: 5px 5px 5px #bbb;
  }

  /* @media (min-width: 600px) {
    #plaintext {
      width: 60%;
      height: 90%;
    }

    #encrypted {
      width: 20%;
      height: 90%;
    }
  } */

</style>

<body>
  <div class="section">
    <b>The last password you'll ever remember FOR FREE, ALWAYS:</b> <input id="password" type="password" size="20"
      maxlength="16" placeholder="password"></input>
    <button id="lockButton">ðŸ”“</button>
    <p id="errorMessage"></p>
  </div>
  <div class="fullheight">
    <div class="floatleft">
      <textarea type="text" id="plaintext"
        placeholder="plaintext, private information that will be encrypted goes here, (for example all the passwords you normally pay a service to store for you)."></textarea>
    </div>
    <div class="floatleft">
      <p id="encryptedtitle" class="padded">Encrypted text</p>
      <textarea type="text" id="encrypted"
        placeholder="encrypted text, copy and backup this text anywhere. To reverse the process just paste encrypted text here first."></textarea>
    </div>
  </div>

  <script type="module">

    function checkPassword() {
      errorMessage("")

      if (password.value.length === 0) {
        errorMessage("Password required")
        return false
      }
      return true
    }

    function bufferToString(buf) {
      return String.fromCharCode(...new Uint8Array(buf));
    }

    function errorMessage(msg) {
      document.getElementById("errorMessage").innerHTML = msg
    }

    function stringToUint8Array(str, size) {
      const buf = new ArrayBuffer(size || str.length);
      const bufView = new Uint8Array(buf);
      for (let i = 0, strLen = str.length; i < strLen; i++) {
        bufView[i] = str.charCodeAt(i);
      }
      return bufView;
    }

    function generateKey() {
      return window.crypto.subtle.importKey(
        "raw",
        stringToUint8Array(password.value, 256 / 8),
        {
          name: "AES-CBC",
          length: 256,
        },
        false,
        ["encrypt", "decrypt"]
      )
    }

    function generateIV() {
      return stringToUint8Array(password.value, 16)
    }

    const plaintext = document.getElementById("plaintext")
    const encrypted = document.getElementById("encrypted")
    const password = document.getElementById("password")
    const lock = document.getElementById("lockButton")

    async function decrypt(key, iv, content, destination, count = 0) {
      if (checkPassword()) {
        try {
          const decryptedText = await window.crypto.subtle.decrypt({
            name: "AES-CBC",
            iv: await generateIV()
          }, await generateKey(), content);
          destination.value = bufferToString(decryptedText)
        } catch (err) {
          throw new Error(`Could not decrypt ${err}`)
        }
      }
    }

    async function encrypt(event) {
      if (checkPassword()) {
        const encryptedText = await window.crypto.subtle.encrypt({
          name: "AES-CBC",
          iv: await generateIV()
        }, await generateKey(), stringToUint8Array(plaintext.value));

        encrypted.value = encodeURI(bufferToString(encryptedText))
      }
    }

    async function retryer(fn, count = 0) {
      try {
        return await fn()
      } catch (err) {
        if (count < 3) {
          throw err
        } else {
          return await retryer(fn, count + 1)
        }
      }
    }

    function retry(fn) {
      return function () {
        retryer(fn, 0).catch((err) => {
          errorMessage(err)
        })
      }
    }

    async function pasteEvent() {
      const content = stringToUint8Array(decodeURI(encrypted.value)) // stringToUint8Array(decodeURI(encrypted.value))
      await decrypt(await generateKey(), await generateIV(), content, plaintext)
    }

    function selectPasswordAction() {
      if (plaintext.value.length > 0) {
        encrypt()
      } else if (encrypted.value.length > 0) {
        retry(pasteEvent)()
      }
    }

    function syncScroll(e) { encrypted.scrollTop = plaintext.scrollTop * 10; }

    plaintext.addEventListener('paste', encrypt);
    plaintext.addEventListener('keydown', encrypt);

    password.addEventListener('keydown', selectPasswordAction)
    password.addEventListener('paste', retry(pasteEvent))

    plaintext.addEventListener('scroll', syncScroll, false);
    plaintext.addEventListener('keydown', syncScroll, false);

    encrypted.addEventListener('paste', retry(pasteEvent))

    encrypted.addEventListener('paste', retry(pasteEvent))

    lock.addEventListener('click', addYubikey)

    function addYubikey() {
      register()
        .then((registeredAccount) => {
          console.log({ registeredAccount })
          return login(registeredAccount)
        })
    }


  </script>

  <script>
  </script>
</body>

</html>
