<!DOCTYPE html>
<html>

<head>
  <title>KeePassWeb</title>
  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîë</text></svg>">
</head>
<script src="./cbor.js" type="text/javascript"></script>
<script src="./webauthn.js" type="text/javascript"></script>
<style>
  html,
  body {
    height: 95%;
    font-family: 'Courier New', monospace;
  }

  input {
    font-family: 'Courier New', monospace;
  }

  textarea {
    resize: none;
  }

  .section {
    padding: 10px;
  }

  .fullheight {
    height: 80%;
    /* display: inline; */
  }

  .floatleft {
    display: inline;
    float: left;
    height: 90%;
    width: 50%;
  }

  #plaintext {
    width: 90%;
    height: 90%;
    display: inline;
    padding: 2%;
    margin: 1%;
  }

  #encrypted {
    width: 90%;
    height: 90%;
    display: inline;
    /* font-size: 0.5em; */
    padding: 2%;
    margin: 1%;
    color: #009c8e;
  }

  #password {
    display: inline;
    padding: 10px;
    height: 2.3em;
    top: 0px;
  }

  .padded {
    margin: 2%;
  }

  #errorMessage {
    color: red;
    display: inline;
    font-style: bold;
  }

  #lockButton {
    /* float: right; */
    color: #fff;
    font-size: 1.8em;
    border-radius: 4px;
    /* margin-right: 10px; */
    /* text-shadow: 5px 5px 5px #bbb; */
  }

  #lockButtonContainer {
    display: inline;
    padding-top: 10px;

  }

  .unlocked {
    border: 2px 2px #fff;
    border-color: #9aca3c
  }

  .locked {
    border: 2px 2px #000;
    border-color: #000;
  }

  .mainText {
    margin-left: 10px;
  }

  /* @media (min-width: 600px) {
    #plaintext {
      width: 60%;
      height: 90%;
    }

    #encrypted {
      width: 20%;
      height: 90%;
    }
  } */
  .lockText {
    font-size: 20px;
    text-shadow: 0px 0px #000;
    color: #9aca3c;
  }

  .yubikeyId {
    display: inline;
  }

  .passwordLabel {
    display: inline;
  }

  .button2fa {
    height: 2em;
    width: 100%;
  }

  .toptable tr>*:nth-child(1) {
    width: 5%;
  }

  .toptable tr>*:nth-child(2) {
    width: 90%;
  }

</style>

<body>
  <table class="toptable" style="width:100%">
    <tbody>
      <tr>
        <th>
          <p class="passwordLabel">Password</p>
          </td>
        <td>
          <input id="passwordInput" type="password" size="80" maxlength="80" placeholder="password required"></input>
        </td>
      </tr>
      <tr>
        <td>
          <button id="touchIdButton" class="button2fa">Touch ID</button>
        </td>
        <td>
          <input id="touchIdInput" type="text" size="80" maxlength="80" placeholder="Touch ID Key"
            disabled="true"></input>
        </td>
      </tr>
      <tr>
        <td>
          <button id="yubikeyButton" class="button2fa">Yubikey</button>
        </td>
        <td>
          <input id="yubikeyInput" type="text" size="80" maxlength="80" placeholder="Yubikey Key"
            disabled="true"></input>
        </td>
      </tr>
    </tbody>
  </table>
  <p id="errorMessage"></p>
  </div>
  <div class="fullheight">
    <div class="floatleft">
      <p id="encryptedtitle" class="padded">Plain text</p>
      <textarea type="text" id="plaintext" placeholder="Write here"></textarea>
    </div>
    <div class="floatleft">
      <p id="encryptedtitle" class="padded">Encrypted text</p>
      <textarea type="text" id="encrypted" placeholder="" value="" spellcheck="false"></textarea></textarea>
    </div>
  </div>

  <script type="module">

    const state = localStorage.getItem('state') ? JSON.parse(localStorage.getItem('state')) :
      {
        "keys": {
          "platform": {},
          "cross-platform": {},
          "password": "123"
        }
      }

    const plaintext = document.getElementById("plaintext")
    const encrypted = document.getElementById("encrypted")
    const password = document.getElementById("passwordInput")
    const yubikey = document.getElementById("yubikeyInput")
    const yubikeyBtn = document.getElementById("yubikeyButton")
    const touchid = document.getElementById("touchIdInput")
    const touchidBtn = document.getElementById("touchIdButton")

    plaintext.addEventListener('paste', encryptEvent);
    plaintext.addEventListener('keyup', encryptEvent);

    password.addEventListener('keyup', encryptEvent)
    password.addEventListener('paste', retry(decryptEvent))

    plaintext.addEventListener('scroll', syncScroll, false);
    plaintext.addEventListener('keydown', syncScroll, false);

    encrypted.addEventListener('paste', retry(decryptEvent))

    yubikeyBtn.addEventListener('click', addYubikey.bind(null, "cross-platform"))
    touchidBtn.addEventListener('click', addYubikey.bind(null, "platform"))

    function checkPassword() {
      errorMessage("")
      if (password.value.length === 0) {
        errorMessage("Password required")
        return false
      }
      return true
    }

    function toHexString(byteArray) {
      return Array.prototype.map.call(byteArray, function (byte) {
        return ('0' + (byte & 0xFF).toString(16)).slice(-2);
      }).join('');
    }

    function toByteArray(hexString) {
      var result = [];
      for (var i = 0; i < hexString.length; i += 2) {
        result.push(parseInt(hexString.substr(i, 2), 16));
      }
      return result;
    }

    function errorMessage(msg) {
      document.getElementById("errorMessage").innerHTML = msg
    }

    function stringToUint8Array(str, size) {
      const buf = new ArrayBuffer(size || str.length);
      const bufView = new Uint8Array(buf);
      for (let i = 0, strLen = str.length; i < strLen; i++) {
        bufView[i] = str.charCodeAt(i);
      }
      return bufView;
    }

    function bufferArrayToUint8Array(str, size) {
      const buf = new ArrayBuffer(size || str.length);
      const bufView = new Uint8Array(buf);
      for (let i = 0, strLen = str.length; i < strLen; i++) {
        bufView[i] = str[i];
      }
      return bufView;
    }

    function bufferToString(buf) {
      return String.fromCharCode(...new Uint8Array(buf));
    }


    function uint8ToHex(encryptedText) {
      return toHexString(new Uint8Array(encryptedText))
    }

    function hexTouint8(encriptedText) {
      return bufferArrayToUint8Array(toByteArray(encriptedText))
    }

    function generateKey(key, i) {
      // console.log("key1", state.keys.password)
      // console.log("key", key)
      // console.log("KEY", key.slice(32 * i, 32 * (i + 1)))
      return window.crypto.subtle.importKey(
        "raw",
        stringToUint8Array(key.slice(32 * i, 32 * (i + 1)), 256 / 8),
        {
          name: "AES-CBC",
          length: 256,
        },
        false,
        ["encrypt", "decrypt"]
      )
    }

    function generateIV() {
      return stringToUint8Array(password.value, 16)
    }

    async function decrypt(key, iv, content, destination, count = 0) {
      const decryptedText = await window.crypto.subtle.decrypt({
        name: "AES-CBC",
        iv,
      }, key, (content));
      return (decryptedText)
    }

    async function encrypt(key, iv, content, destination, event) {
      const encryptedText = await window.crypto.subtle.encrypt({
        name: "AES-CBC",
        iv
      }, key, content);
      return (encryptedText)
    }

    async function retryer(fn, count = 0) {
      try {
        return await fn()
      } catch (err) {
        if (count < 3) {
          throw err
        } else {
          return await retryer(fn, count + 1)
        }
      }
    }

    function retry(fn) {
      return function () {
        setTimeout(() => {
          retryer(fn).catch((err) => {
            errorMessage(err)
          })
        }, 100)
      }
    }

    let passes = 10

    async function encryptEvent() {
      if(plaintext.value.length === 0) return 0

      let key = [state.keys.password, state.keys.platform.loggedCredentialId, state.keys["cross-platform"].loggedCredentialId].filter(Boolean).join("")

      let value = stringToUint8Array(plaintext.value)
      for (var i = 0; i < key.length / 32; i++) {
        value = await encrypt(await generateKey(key, i), await generateIV(), value)
        console.log('üîë', i, uint8ToHex(value))
      }

      encrypted.value = `${(state.keys.platform.credentialId) || ''}==${state.keys["cross-platform"].credentialId || ''}--${uint8ToHex(value)}`
    }

    async function decryptEvent() {
      let key = [state.keys.password, state.keys.platform.loggedCredentialId, state.keys["cross-platform"].loggedCredentialId].filter(Boolean).join("")

      if (encrypted.value.split("==")[0].length > 0 && encrypted.value.split("==")[0] !== state.keys.platform.credentialId) {
        await addYubikey("platform", null, encrypted.value.split("==")[0].split("--")[0])
      }

      let crossPlatformId = encrypted.value.split("--")[0].split("==")[1]
      if (crossPlatformId.length > 0 && crossPlatformId !== state.keys["cross-platform"].credentialId) {
        await addYubikey("cross-platform", null, crossPlatformId)
      }

      let value = hexTouint8(encrypted.value.split("--")[1])

      for (var i = parseInt(key.length / 32); i >= 0; i--) {
        value = await decrypt(await generateKey(key, i), await generateIV(i), value)
        console.log('üê£', i, bufferToString(value))
      }
      plaintext.value = bufferToString(value)
    }


    function syncScroll(e) {
      encrypted.scrollTop = plaintext.scrollTop * (
        (encrypted.value.length || 0) / (plaintext.nnjlenght || 1)
      );
    }

    let yubikeyCredentialId = null


    updateUI()

    console.log(JSON.stringify(state, null, 2))

    function saveState() {
      localStorage.setItem('state', JSON.stringify(state))
      console.log(JSON.stringify(state, null, 2))
    }

    function updateUI() {
      yubikeyInput.value = state.keys['cross-platform'].loggedCredentialId || ''
      touchIdInput.value = state.keys['platform'].loggedCredentialId || ''
      passwordInput.value = state.keys['password'] || ''
    }

    async function addYubikey(authtype, event, setCredentialId) {
      console.log("addYubikey", authtype, event, setCredentialId)
      try {
        state.keys[authtype] = {}
        const credentialId = (setCredentialId && hexTouint8(setCredentialId)) || await register(authtype)
        const loggedCredentials = await login(credentialId)
        state.keys[authtype].credentialId = uint8ToHex(credentialId)
        state.keys[authtype].loggedCredentialId = loggedCredentials.id
      } catch (err) {
        console.log(err)
      }
      saveState()
      updateUI()
    }

    // Testing only:
    // plaintext.value = "hello world"
    // encryptEvent()

    // encrypted.value = "016241048c31d67aa96771f4b3aec12d872bfd101538b74826995ff1b94fca77902a==af22c0b8ef046b6961237033d638e1a99f72fad9be02aaa1a130e6b369c4aeffa8ae0ccd97ce0d3571478466ec6596fbffd889726aab21d43da5c212b7f7250f--db764c9b0680b7c789b264eb1838e30f1beb1df9d2fca1c7390ebd5962df9c72dc2e425b9c99073555e93c73516c002a78949aec7a5088a5e320cbea237843b8cdc15da9f6a5125a3a4ae2c54ac9f8ea"
    // decryptEvent()

  </script>

  <script>
  </script>
</body>

</html>
